# Архитектура приложения Call Mom

## Обзор

Call Mom - это P2P приложение для видеозвонков, построенное на React Native с использованием WebRTC. Приложение использует бессерверную архитектуру, где соединение устанавливается напрямую между двумя устройствами.

## Архитектурные принципы

### 1. Модульность
- Каждый компонент имеет четко определенную ответственность
- Слабая связанность между модулями
- Высокая когезия внутри модулей

### 2. Абстракция
- WebRTC API абстрагирован для поддержки различных реализаций
- Универсальный интерфейс для работы с медиапотоками
- Независимость от конкретных библиотек

### 3. Безопасность
- Использование DTLS и SRTP для шифрования
- Unified Plan семантика SDP
- Валидация всех входящих данных

## Структура проекта

```
src/
├── components/          # React компоненты
│   └── WebRTCDemo.tsx  # Демонстрационный компонент
├── hooks/              # React хуки
│   └── useWebRTC.ts    # Хук для работы с WebRTC
├── services/           # Бизнес-логика
│   └── WebRTCService.ts # Основной WebRTC сервис
├── types/              # TypeScript типы
│   └── webrtc.ts       # Типы для WebRTC
├── utils/              # Утилиты
│   ├── signaling.ts    # Утилиты сигналинга
│   └── clipboard.ts    # Утилиты буфера обмена
├── constants/          # Константы
│   └── index.ts        # Конфигурация приложения
└── examples/           # Примеры использования
    └── WebRTCExample.ts # Примеры API
```

## Основные компоненты

### 1. WebRTCService

**Назначение**: Центральный сервис для управления WebRTC соединениями

**Ключевые функции**:
- Создание и управление RTCPeerConnection
- Обработка SDP оферов и ответов
- Сбор и обработка ICE кандидатов
- Управление медиапотоками
- Обработка событий соединения

**Архитектурные особенности**:
- Абстрактный интерфейс WebRTC API
- Поддержка различных реализаций
- Асинхронная обработка событий
- Автоматическая очистка ресурсов

### 2. Signaling Utils

**Назначение**: Утилиты для сериализации и обмена данными сигналинга

**Ключевые функции**:
- Сериализация SDP в base64
- Создание компактных строк для обмена
- Валидация данных сигналинга
- Поддержка глубоких ссылок

**Форматы данных**:
```typescript
interface SerializedSignalingData {
  offer?: string;           // base64 encoded SDP
  answer?: string;          // base64 encoded SDP
  iceCandidates?: string[]; // base64 encoded ICE candidates
  timestamp: number;        // timestamp создания
}
```

### 3. React Hook (useWebRTC)

**Назначение**: Удобный интерфейс для React компонентов

**Ключевые функции**:
- Управление состоянием соединения
- Обработка событий WebRTC
- Интеграция с React lifecycle
- Обработка ошибок

**Состояния**:
- `connectionState`: Состояние соединения
- `iceConnectionState`: Состояние ICE
- `localStream`: Локальный медиапоток
- `remoteStream`: Удаленный медиапоток
- `isConnected`: Флаг подключения
- `hasError`: Флаг ошибки

### 4. Demo Component

**Назначение**: Демонстрация функциональности WebRTC

**Ключевые функции**:
- UI для инициации звонка
- UI для принятия звонка
- Отображение данных для обмена
- Интеграция с буфером обмена
- Отображение статуса соединения

## Поток данных

### 1. Инициация звонка

```
Пользователь → WebRTCDemo → useWebRTC → WebRTCService
    ↓
Создание соединения → Получение медиапотока → Создание офера
    ↓
Сбор ICE кандидатов → Сериализация данных → Копирование в буфер
```

### 2. Принятие звонка

```
Пользователь → Вставка данных → Парсинг → WebRTCService
    ↓
Создание соединения → Получение медиапотока → Установка удаленного описания
    ↓
Создание ответа → Сбор ICE кандидатов → Сериализация ответа
```

### 3. Установка соединения

```
Инициатор → Получение ответа → Установка удаленного описания
    ↓
Добавление ICE кандидатов → Установка соединения
    ↓
Обмен медиапотоками → Начало видеозвонка
```

## Безопасность

### 1. Шифрование

- **DTLS**: Шифрование данных сигналинга
- **SRTP**: Шифрование медиапотоков
- **Unified Plan**: Современная семантика SDP

### 2. Валидация

- Проверка формата SDP
- Валидация ICE кандидатов
- Проверка временных меток
- Санитизация пользовательского ввода

### 3. Конфигурация

```typescript
const config = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' }
  ],
  sdpSemantics: 'unified-plan',
  bundlePolicy: 'max-bundle',
  rtcpMuxPolicy: 'require',
  iceCandidatePoolSize: 10,
};
```

## Производительность

### 1. Оптимизация медиа

```typescript
const mediaConstraints = {
  video: {
    width: { ideal: 640, max: 1280 },
    height: { ideal: 480, max: 720 },
    frameRate: { ideal: 30, max: 60 },
  },
  audio: {
    echoCancellation: true,
    noiseSuppression: true,
    autoGainControl: true,
  },
};
```

### 2. Управление ресурсами

- Автоматическая очистка соединений
- Остановка медиапотоков при завершении
- Освобождение памяти от ICE кандидатов
- Отписка от событий

### 3. Мониторинг

- Статистика соединения
- Логирование ключевых событий
- Обработка ошибок
- Отслеживание состояния

## Расширяемость

### 1. Поддержка новых платформ

Архитектура позволяет легко добавлять поддержку новых платформ:

```typescript
// Пример для новой платформы
class NewPlatformWebRTCService extends WebRTCService {
  protected initializeWebRTCAPI(): void {
    this.webrtcAPI = newPlatformWebRTCAPI;
  }
}
```

### 2. Дополнительные функции

- Групповые звонки
- Запись звонков
- Демонстрация экрана
- Чат во время звонка

### 3. Интеграция с внешними сервисами

- TURN серверы
- Серверы сигналинга
- Системы аутентификации
- Аналитика

## Тестирование

### 1. Unit тесты

- Тестирование WebRTCService
- Тестирование утилит сигналинга
- Тестирование React хуков

### 2. Integration тесты

- Тестирование полного цикла звонка
- Тестирование обмена данными
- Тестирование обработки ошибок

### 3. E2E тесты

- Тестирование на реальных устройствах
- Тестирование в разных сетях
- Тестирование производительности

## Мониторинг и отладка

### 1. Логирование

```typescript
// Структурированное логирование
console.log('WebRTC Event:', {
  type: 'connection-state-change',
  state: connectionState,
  timestamp: Date.now(),
  sessionId: sessionId,
});
```

### 2. Метрики

- Время установки соединения
- Качество медиапотоков
- Статистика сети
- Ошибки соединения

### 3. Отладка

- Детальные логи WebRTC
- Визуализация состояния
- Инструменты профилирования
- Анализ производительности

## Заключение

Архитектура Call Mom обеспечивает:

- ✅ **Модульность**: Легко тестировать и поддерживать
- ✅ **Безопасность**: Современные стандарты шифрования
- ✅ **Производительность**: Оптимизированная работа с медиа
- ✅ **Расширяемость**: Готовность к новым функциям
- ✅ **Надежность**: Обработка ошибок и восстановление

Архитектура готова для интеграции с нативными WebRTC библиотеками и может быть легко адаптирована под различные требования проекта.
